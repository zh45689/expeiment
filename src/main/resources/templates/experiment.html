<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>实验</title>
		<script src="js/vue.js"></script>
		<script src="js/axios.min.js"></script>
		<link rel="stylesheet" href="css/index.css">
		<script src="js/index.js"></script>
	</head>
	<body>
		<div id="box">
			<el-form :inline="true" ref="condition" :model="condition" label-width="80px">
				<el-form-item label="实验名称">
					<el-input v-model="condition.ename"></el-input>
				</el-form-item>
				<el-form-item label="负责人">
					<el-input v-model="condition.name"></el-input>
				</el-form-item>
				<el-form-item label="实验类别">
					<el-select v-model="condition.tname" placeholder="请选择">
						<el-option v-for="type in typeList" :label="type.tname" :value="type.tname"></el-option>
					</el-select>
				</el-form-item>
				<el-form-item label="创建时间">
					<el-date-picker v-model="condition.etime" type="date"></el-date-picker>
				</el-form-item>
				<el-form-item>
					<el-button type="primary" @click="selectAllExp">搜索</el-button>
				</el-form-item>
			</el-form>
			<el-table :data="expList" border style="width: 100%">
		    	<el-table-column prop="ename" label="实验名称"></el-table-column>
		    	<el-table-column prop="user.name" label="负责人"></el-table-column>
		    	<el-table-column prop="etime" label="创建时间"></el-table-column>
		    	<el-table-column prop="type.tname" label="实验类别"></el-table-column>
		    	<el-table-column fixed="right" label="操作">
			      <template slot-scope="scope">
			        <el-button @click="selectDetail(scope.row.eid)" type="text" size="small">详情</el-button>
			        <el-button @click="collection(scope.row.eid)" type="text" size="small">收藏</el-button>
					  <el-button @click="exportExcel(scope.row.eid)" size="small" type="text">导出Excel</el-button>
			      </template>
			    </el-table-column>
			</el-table>
			<el-pagination
				@size-change="handleSizeChange"
				@current-change="handleCurrentChange"
			    :current-page="currentPage"
			    :page-sizes="[5, 10, 15, 20]"
			    :page-size="pageSize"
			    layout="total, sizes, prev, pager, next,jumper"
			    :total="total">
			</el-pagination>

			<el-dialog title="实验详情" :visible.sync="detailVisible" width="45%">
				<!--描述面板-->
				<el-descriptions>
					<el-descriptions-item label="实验名称">{{experiment.ename}}</el-descriptions-item>
					<el-descriptions-item label="创建时间">{{experiment.etime}}</el-descriptions-item>
					<el-descriptions-item label="负责人">{{experiment.user.name}}</el-descriptions-item>
					<el-descriptions-item label="实验类别">{{experiment.type.tname}}</el-descriptions-item>
				</el-descriptions>
				<!--折叠面板-->
				<el-collapse v-for="step in experiment.steps">
				<el-collapse-item :title="step.sname">
					<div>{{step.sdata}}</div>
				</el-collapse-item>
				</el-collapse>
			</el-dialog>
		</div>
		<script>
			new Vue({
				el:"#box",
				data:{
					detailVisible:false,
					condition:{},
					experiment:{
						user:{name:""},
						type:{tname:""},
						steps:[]
					},
					expList:[],
					typeList:[],
					currentPage:1,
					pageSize:5,
					total:0
				},
				methods:{
					//当前页码数改变函数
					handleCurrentChange:function(val){
						this.currentPage = val;
						this.selectAllExp();
					},
					//页面总条目改变函数
					handleSizeChange:function(val){
						this.pageSize = val;
						this.selectAllExp();
					},
					//查询所有实验数据
					selectAllExp:function(){
						var that = this;
						var currentPage = this.currentPage;
						var pageSize = this.pageSize;
						var condition = this.condition;
						condition.currentPage = currentPage;
						condition.pageSize = pageSize;
						var conditionJson = JSON.stringify(condition);
						var formData = new FormData();
						formData.append("conditionJson",conditionJson);
						let options = {
							url:"selectAllExp",
							method:"post",
							data:formData
						}
						axios(options).then(function(result){
							if(result.data.status){
								that.expList = result.data.list;
								that.total = result.data.total;
							}else{
								that.$message.error(result.data.message);
							}
						});
					},
					//查询所有实验类别
					selectAllType:function(){
						var that = this;
						axios.get("selectAllType").then(function(result){
							if(result.data.status){
								that.typeList = result.data.list;
							}else{
								that.$message.error(result.data.message);
							}
						});
					},
					collection:function(eid){
						var that = this;
						axios.get("addCollection?eid="+eid).then(function(result){
							if(result.data.status){
								that.selectAllExp();
							}else{
								that.$message.error(result.data.message);
							}
						});
					},
					selectDetail:function(eid){
						var that = this;
						axios.get("selectDetail?eid="+eid).then(function(result){
							if(result.data.status){
								that.experiment = result.data.object;
								that.detailVisible = true;
							}else{
							that.$message.warning(result.data.message);
							}
						});
					},
					//导出实验数据到Excel表格
					exportExcel:function (eid) {
						var that = this;
						axios.get("exportExcel?eid="+eid).then(function(result){
							if(result.data.status){
								that.$message.success("导出成功");
							}else{
								that.$message.warning(result.data.message);
							}
						});
					}
				},
				beforeMount:function(){
					this.selectAllType();
				},
				mounted:function(){
					this.selectAllExp();
				}
			})
		</script>
	</body>
</html>
